name: Auto-deployment of nmdc_submission_schema documentation and DH interface
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-docs:
    # TODO: this should probably be split into separate build and deploy jobs to 
    # reduce privileged token exposure
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main
        with:
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo

      - name: Set up Python 3.
        uses: actions/setup-python@v3
        with:
          python-version: 3.9

      - name: Install Poetry.
        uses: snok/install-poetry@v1.3

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16

      - name: Install Python dependencies.
        run: poetry install -E docs

      - name: Install JavaScript dependencies.
        working-directory: data_harmonizer
        run: npm install

      - name: Regenerate schema
        run: make squeaky-clean generated_schema/mixs_6_2_proposal.yaml schema_derivatives/mixs_6_2_proposal.json

      - name: Build documentation.
        run: |
          rm -rf mixs-docs-md
          mkdir -p mixs-docs-md
          touch mixs-docs-md/.gitkeep          
          rm -rf dist
          mkdir -p dist
          touch dist/.gitkeep
          ls -l mixs-docs-md
          poetry run gen-doc -d mixs-docs-md generated_schema/mixs_6_2_proposal.yaml
          ls -l mixs-docs-md
          #        cp src/docs/*md docs/
          ls -l dist
          poetry run mkdocs build -d dist
          ls -l dist
          
      - name: Build DataHarmonizer interface.
        working-directory: data_harmonizer
        run: |
          npm run build -- --outDir ../dist/_playground --base /${{ github.event.repository.name }}/_playground/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: dist

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v1
